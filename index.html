<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="xmlui/0.9.23.js"></script>
    <script src="xmlui/charts-0.1.12.js"></script>
    <script>
        window.formatAsCurrency = function (value) {
            const num = parseFloat(value);
            if (isNaN(num)) {
                return '$0.00';
            }
            return '$' + num.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        }

        window.formatToday = function (plusDays = 0) {
            const date = new Date();
            if (plusDays !== 0) {
                date.setDate(date.getDate() + plusDays);
            }
            return date.toISOString().slice(0, 10).replace(/-/g, '/');
        }

        window.monthlyRevenue = function () {
            const query = `
                select
                    substr(issue_date, 1, 7) AS month,  -- 'YYYY/MM'
                    sum(total) AS total
                from
                    invoices
                where
                    status = 'paid'
                group by
                    month
                order by
                    month
            `;
            return { sql: query };
        }

        window.outstanding = function () {
            const query = `
                select
                    sum(total) as value
                from
                    invoices
                where
                    status != 'paid'
                `
            return { sql: query }
        }

        window.paidThisYear = function () {
            const query = `
                select
                    sum(total) as value
                from
                    invoices
                where
                    status = 'paid'
                    and substr(issue_date, 1, 4) = strftime('%Y', 'now')
                `
            return { sql: query }
        }

        window.totalInvoices = function () {
            const query = `
                select
                    count(*) as value
                from
                    invoices
                `
            return { sql: query }
        }

        window.totalClients = function () {
            const query = `
                select
                    count(*) as value
                from
                clients;
                `
            return { sql: query }
        }

        window.invoices = function () {
            const query = `
                select
                    invoices.invoice_number as "Invoice #",
                    clients.name as Client,
                    substr(invoices.issue_date, 0, 11) as "Issue Date",
                    substr(invoices.due_date, 0, 11) as "Due Date",
                    invoices.total as Amount,
                    invoices.status as Status,
                    invoices.notes as Notes
                from
                    invoices
                join
                    clients on invoices.client_id = clients.id
                order by
                    invoices.due_date desc
            `
            return { sql: query }
        }

        window.totalInvoicesByStatus = function (status) {
            const query = `
                select
                    count(*) as value
                from
                    invoices
                where
                    status = '${status}'
            `
            return { sql: query }
        }


        window.clients = function () {
            const query = `
                select
                    c.name as "Name",
                    c.email as "Email",
                    c.phone as "Phone",
                    coalesce(sum(case when i.status != 'paid' then i.total else 0 end), 0) as "Outstanding"
                from
                    clients c
                left join
                    invoices i on c.id = i.client_id and i.status != 'paid'
                group by
                    c.id, c.name, c.email, c.phone
                order by
                    Name
            `
            return { sql: query }
        }

        window.products = function () {
            const query = `
                select * from products order by name
            `
            return { sql: query }
        }

        window.productDetails = function (name) {
            console.log('productDetails for', name)
            const query = `
                select * from products where name = '${name}'
            `
            console.log(query)
            return { sql: query }
        }

        window.saveInvoice = function (invoiceData) {
            console.log('Saving invoice data:', invoiceData);

            const itemsJson = JSON.stringify(invoiceData.lineItems).replace(/'/g, "''");

            const total = invoiceData.lineItems?.reduce((sum, item) => sum + (Number(item.amount) || 0), 0);

            // Get client ID based on name
            const clientName = invoiceData.client;

            const query = `
                insert into invoices (
                    client_id,
                    invoice_number,
                    issue_date,
                    due_date,
                    total,
                    items,
                    status
                )
                select
                    c.id,
                    'INV-' || (SELECT COUNT(*) + 1001 from invoices),
                    '${invoiceData.issueDate}',
                    '${invoiceData.dueDate}',
                    ${total},
                    '${itemsJson}',
                    'draft'
                from
                    clients c
                where
                    c.name = '${clientName}'
            `;

            console.log('Save invoice query:', query);
            return { sql: query };
        };


    </script>
</head>

<body></body>

</html>