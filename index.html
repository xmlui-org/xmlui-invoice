<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="xmlui/0.9.5.js"></script>
    <script src="xmlui/charts-0.1.12.js"></script>
    <script>
        window.xmluiHost = "http://hn.jonudell.info:8083"

        window.formatAsCurrency = function (value) {
            const num = parseFloat(value);
            if (isNaN(num)) {
                return '$0.00';
            }
            return '$' + num.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        }

        window.monthlyRevenue = function () {
            const query = `
                select
                    substr(
                        'JanFebMarAprMayJunJulAugSepOctNovDec', -- A string containing all month abbreviations concatenated together
                        1 + 3 * (strftime('%m', issue_date) - 1), -- Calculate the starting position for extraction
                        -- Breaking down the position calculation:
                        -- strftime('%m', issue_date)     -- Extract month number (1-12)
                        -- strftime('%m', issue_date) - 1 -- Convert to 0-based index (0-11)
                        -- 3 * (...)                      -- Multiply by 3 because each abbreviation is 3 chars
                        -- 1 + ...                        -- Add 1 because SQLite substr is 1-indexed
                        3 -- Extract exactly 3 characters (the month abbreviation)
                    ) as month,
                    sum(total) as total
                from
                    invoices
                where
                    status = 'paid'
                group by
                    month
                order by
                    strftime('%m', issue_date)
            `
            return { sql: query }
        }

        window.outstanding = function () {
            const query = `
                select
                    sum(total) as value
                from
                    invoices
                where
                    status != 'paid'
                `
            return { sql: query }
        }

        window.paidThisYear = function () {
            const query = `
                select
                    sum(total) as value
                from
                    invoices
                where
                    status = 'paid'
                    and strftime('%Y', issue_date) = strftime('%Y', 'now');
                `
            return { sql: query }
        }

        window.totalInvoices = function () {
            const query = `
                select
                    count(*) as value
                from
                    invoices
                `
            return { sql: query }
        }

        window.totalClients = function () {
            const query = `
                select
                    count(*) as value
                from
                clients;
                `
            return { sql: query }
        }

        window.invoices = function () {
            const query = `
                select
                    invoices.invoice_number as "Invoice #",
                    clients.name as "Client",
                    substr(invoices.issue_date, 0, 11) as "Issue Date",
                    substr(invoices.due_date, 0, 11) as "Due Date",
                    invoices.total as "Amount",
                    upper(invoices.status) as "Status"
                from
                    invoices
                join
                    clients on invoices.client_id = clients.id
                order by
                    invoices.issue_date
            `
            return { sql: query }
        }

        window.clients = function () {
            const query = `
                select
                    c.name as "Name",
                    c.email as "Email",
                    c.phone as "Phone",
                    coalesce(sum(case when i.status != 'paid' then i.total else 0 end), 0) as "Outstanding"
                from
                    clients c
                left join
                    invoices i on c.id = i.client_id and i.status != 'paid'
                group by
                    c.id, c.name, c.email, c.phone
                order by
                    "Outstanding" desc;
            `
            return { sql: query }
        }
    </script>
</head>

<body></body>

</html>