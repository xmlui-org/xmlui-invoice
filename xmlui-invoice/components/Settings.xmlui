<Component name="Settings">
  <AppState id="currentUser" bucket="userState" />
  <AppState id="settings" bucket="settingsState" />
  <DataSource id="users" url="/api/users"/>
    <ChangeListener
    listenTo="{settings.value}"
    onDidChange="{() => {
      console.log('Settings component sees AppState change:', settings.value);
    }}"
  />
  <H1>
    Settings
  </H1>
  <Card>
    <HStack>
      <H2>
        Users
      </H2>
      <SpaceFiller/>
      <Button label="Add User" onClick="Actions.navigate('/users/new')"/>
    </HStack>
    <RadioGroup
      id="userSelector"
      initialValue="{loggedInUser.username}"
      onDidChange="(val) => {
        // Find the selected user and update currentUser AppState
        const selectedUser = users.value.find(u => u.username === val);
        console.log('selectedUser', JSON.stringify(selectedUser))
        if (selectedUser) {
          currentUser.update({
            username: selectedUser.username,
            display_name: selectedUser.display_name,
            avatar_url: selectedUser.avatar_url
          });
        };
      }"
    >
      <Table data="{users}">
        <Column bindTo="username" width="*"/>
        <Column bindTo="display_name"/>
        <Column bindTo="email" width="2*" />
        <Column canSort="{false}" header="avatar">
          <InvoiceAvatar url="{$item.avatar_url}" name="{loggedInUser.display_name}" borderRadius="{settings.value.avatar_border_radius}"/>
        </Column>
        <Column canSort="{false}" header="logged_in" width="*">
          <Option value="{$item.username}" />
        </Column>
      </Table>
    </RadioGroup>
  </Card>

  <Card>
    <H2>Avatar Settings</H2>
    Border radius
    <TextBox
      width="10rem"
      id="borderRadiusInput"
      placeholder="e.g. 50% or 10px"
      value="{settings.value.avatar_border_radius}"
    />
    <ChangeListener
      listenTo="{borderRadiusInput.value}"
      onDidChange="{() => {
        // Only update if we have a valid value and settings is loaded
        if (borderRadiusInput.value && settings.value) {
          settings.update({
            avatar_border_radius: borderRadiusInput.value
          });
        }
      }}"
    />
  </Card>
</Component>
